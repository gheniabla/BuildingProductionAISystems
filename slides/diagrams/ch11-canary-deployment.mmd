flowchart TD
    subgraph P1 ["PHASE 1: Initial Canary - 1 hour"]
        T1["Traffic"]:::client
        T1 -- "99%" --> S1["Stable"]:::service
        T1 -- "1%" --> C1["Canary"]:::external
        Cr1["error_rate < 0.1%<br/>latency_p99 < 2x stable"]:::observability
    end

    P1 -- "Pass" --> P2

    subgraph P2 ["PHASE 2: Expanded Canary - 2 hours"]
        T2["Traffic"]:::client
        T2 -- "90%" --> S2["Stable"]:::service
        T2 -- "10%" --> C2["Canary"]:::external
        Cr2["same + user_satisfaction >= stable"]:::observability
    end

    P2 -- "Pass" --> P3

    subgraph P3 ["PHASE 3: 50/50 Split - 4 hours"]
        T3["Traffic"]:::client
        T3 -- "50%" --> S3["Stable"]:::service
        T3 -- "50%" --> C3["Canary"]:::external
        Cr3["Full parity across all metrics"]:::observability
    end

    P3 -- "Pass" --> P4

    subgraph P4 ["PHASE 4: Full Rollout"]
        T4["Traffic"]:::client
        T4 -- "100%" --> N4["New Version"]:::data
        Note4["Keep old version 24h<br/>for quick rollback"]:::observability
    end

    P1 -- "Fail" --> RB["AUTOMATIC ROLLBACK"]:::gateway
    P2 -- "Fail" --> RB
    P3 -- "Fail" --> RB

    RB --- Triggers["Error rate > 1%<br/>p99 latency > 3x baseline<br/>Cost per request > 2x baseline<br/>Quality score drops > 10%<br/>Manual trigger from on-call"]:::gateway

    classDef client fill:#3B82F6,stroke:#1D4ED8,color:#FFFFFF
    classDef gateway fill:#EF4444,stroke:#B91C1C,color:#FFFFFF
    classDef service fill:#4F46E5,stroke:#3730A3,color:#FFFFFF
    classDef data fill:#10B981,stroke:#047857,color:#FFFFFF
    classDef external fill:#F59E0B,stroke:#D97706,color:#FFFFFF
    classDef observability fill:#8B5CF6,stroke:#6D28D9,color:#FFFFFF
